<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revu - TripAdvisor Redirect</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Toast for auto-copy success - centered on screen */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #00AF87;
            color: white;
            padding: 24px 48px;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        /* Loading state - minimal */
        .loading-container {
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00AF87;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 14px;
        }

        /* Fallback container - only shown when auto-copy fails */
        .fallback-container {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: none;
        }

        .fallback-container h2 {
            color: #333;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .fallback-container p {
            color: #666;
            font-size: 15px;
            margin-bottom: 25px;
        }

        .copy-btn {
            background: #00AF87;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            max-width: 280px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #009973;
            transform: translateY(-2px);
        }

        .copy-btn:active {
            transform: scale(0.98);
        }

        .copy-btn.copied {
            background: #4CAF50;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- Toast for auto-copy success -->
    <div class="toast" id="toast">Copied!</div>

    <!-- Loading state (shown initially) -->
    <div class="loading-container" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">Loading...</p>
    </div>

    <!-- Fallback UI - only shown when auto-copy fails -->
    <div class="fallback-container" id="fallback">
        <h2>Copy Your Review</h2>
        <p>Tap the button below, then paste on TripAdvisor</p>
        <button class="copy-btn" id="copyBtn">Copy to Clipboard</button>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        const BACKEND_URL = "https://revu.up.railway.app";

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showFallback() {
            document.getElementById('fallback').style.display = 'block';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================================================
        // CLIPBOARD FUNCTIONS
        // ============================================================================
        async function tryAutoCopy(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                console.log('[REDIRECT] Auto-copy failed:', err.message);
                return false;
            }
        }

        async function copyWithButton(text) {
            // Method 1: Clipboard API (works with user gesture)
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                console.log('[REDIRECT] Clipboard API failed, trying fallback');
            }

            // Method 2: execCommand fallback
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                textarea.setAttribute('readonly', '');
                document.body.appendChild(textarea);

                // iOS needs special handling
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    const range = document.createRange();
                    range.selectNodeContents(textarea);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    textarea.setSelectionRange(0, text.length);
                } else {
                    textarea.focus();
                    textarea.select();
                }

                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (success) return true;
            } catch (err) {
                console.log('[REDIRECT] execCommand failed');
            }

            return false;
        }

        // ============================================================================
        // MAIN REDIRECT LOGIC
        // ============================================================================
        async function handleRedirect() {
            try {
                // Parse URL parameters
                const params = new URLSearchParams(window.location.search);
                const reviewId = params.get('review_id');
                const tripadvisorUrlParam = params.get('tripadvisor_url');

                console.log('[REDIRECT] Starting TripAdvisor redirect...');
                console.log('[REDIRECT] Review ID:', reviewId);

                // Validate
                if (!reviewId) {
                    alert('Error: Missing review ID');
                    return;
                }

                // Fetch data from API
                console.log('[REDIRECT] Fetching review data...');
                const response = await fetch(`${BACKEND_URL}/api/review-text/${reviewId}`);

                if (!response.ok) {
                    throw new Error(`Failed to load review (${response.status})`);
                }

                const data = await response.json();
                console.log('[REDIRECT] Data fetched successfully');

                // Build redirect URL - prefer URL from API, fallback to URL param
                let redirectUrl;
                if (data.business_tripadvisor_url) {
                    redirectUrl = data.business_tripadvisor_url;
                } else if (tripadvisorUrlParam) {
                    redirectUrl = decodeURIComponent(tripadvisorUrlParam);
                } else {
                    alert('Error: TripAdvisor URL not available');
                    return;
                }

                // Track click (non-blocking)
                fetch(`${BACKEND_URL}/api/track-tripadvisor-click/${reviewId}`, { method: 'POST' }).catch(() => {});

                // ===== SEAMLESS AUTO-COPY ATTEMPT =====
                const textToCopy = data.review_text;

                if (textToCopy) {
                    const autoCopySuccess = await tryAutoCopy(textToCopy);

                    if (autoCopySuccess) {
                        // SUCCESS: Show toast and redirect immediately
                        console.log('[REDIRECT] Auto-copy succeeded - seamless redirect');
                        hideLoading();
                        showToast('Copied!');
                        await delay(1000);
                        window.location.href = redirectUrl;
                        return;
                    }

                    // FAILED: Show fallback copy button
                    console.log('[REDIRECT] Auto-copy failed, showing fallback UI');
                    hideLoading();
                    showFallback();

                    // Set up copy button
                    const copyBtn = document.getElementById('copyBtn');
                    copyBtn.addEventListener('click', async () => {
                        const success = await copyWithButton(textToCopy);
                        if (success) {
                            copyBtn.textContent = 'Copied!';
                            copyBtn.classList.add('copied');
                            await delay(800);
                            window.location.href = redirectUrl;
                        } else {
                            copyBtn.textContent = 'Copy failed - tap again';
                        }
                    });

                } else {
                    // No text to copy, just redirect
                    console.log('[REDIRECT] No text to copy, redirecting directly');
                    hideLoading();
                    showToast('Redirecting...');
                    await delay(500);
                    window.location.href = redirectUrl;
                }

            } catch (error) {
                console.error('[REDIRECT] Fatal error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Run on page load
        handleRedirect();
    </script>
</body>
</html>
